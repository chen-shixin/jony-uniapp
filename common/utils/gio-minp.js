"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Uploader{constructor(e,t){this.host="https://wxapi.growingio.com",this.messageQueue=[],this.uploadingQueue=[],this.uploadTimer=null,this.projectId=e,this.appId=t,this.url=`${this.host}/projects/${this.projectId}/apps/${this.appId}/collect`}setHost(e){0!=e.indexOf("http")&&(this.host="https://"+e),this.url=`${this.host}/projects/${this.projectId}/apps/${this.appId}/collect`}upload(e){this.messageQueue.push(e),this.uploadTimer||(this.uploadTimer=setTimeout(()=>{this._flush(),this.uploadTimer=null},1e3))}forceFlush(){this.uploadTimer&&(clearTimeout(this.uploadTimer),this.uploadTimer=null),this._flush()}_flush(){this.uploadingQueue=this.messageQueue.slice(),this.messageQueue=[],this.uploadingQueue.length>0&&wx.request({url:`${this.url}?stm=${Date.now()}`,header:{"content-type":"application/json"},method:"POST",data:this.uploadingQueue,success:()=>{this.messageQueue.length>0&&this._flush()},fail:()=>{this.messageQueue=this.uploadingQueue.concat(this.messageQueue)}})}}var Utils={sdkVer:"1.6.1",devVer:1,guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},getScreenHeight:function(e){return Math.round(e.screenHeight*e.pixelRatio)},getScreenWidth:function(e){return Math.round(e.screenWidth*e.pixelRatio)},getOS:function(e){if(e){var t=e.toLowerCase();return-1!=t.indexOf("android")?"Weixin-Android":-1!=t.indexOf("ios")?"Weixin-iOS":e}},getOSV:e=>`Weixin ${e}`,isEmpty:e=>{for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}};class Page$1{constructor(){this.queries={}}touch(e){this.path=e.route,this.time=Date.now(),this.query=this.queries[e.route]?this.queries[e.route]:void 0}addQuery(e,t){this.queries[e.route]=t?this._getQuery(t):null}_getQuery(e){return Object.keys(e).map(t=>`${t}=${e[t]}`).join("&")}}const eventTypeMap={tap:["tap","click"],longtap:["longtap"],input:["input"],blur:["change","blur"],submit:["submit"],focus:["focus"]},fnExpRE=/^function[^\(]*\([^\)]+\).*[^\.]+\.([^\(]+)\(.*/;function getComKey(e){return e&&e.$attrs?e.$attrs.mpcomid:"0"}function getVM(e,t){void 0===t&&(t=[]);var i=t.slice(1);return i.length?i.reduce(function(e,t){for(var i=e.$children.length,n=0;i>n;n++){var s=e.$children[n];if(getComKey(s)===t)return e=s}return e},e):e}function getHandle(e,t,i){void 0===i&&(i=[]);var n=[];if(!e||!e.tag)return n;var s=e||{},r=s.data;void 0===r&&(r={});var o=s.children;void 0===o&&(o=[]);var a=s.componentInstance;a?Object.keys(a.$slots).forEach(function(e){var s=a.$slots[e];(Array.isArray(s)?s:[s]).forEach(function(e){n=n.concat(getHandle(e,t,i))})}):o.forEach(function(e){n=n.concat(getHandle(e,t,i))});var u=r.attrs,h=r.on;return u&&h&&u.eventid===t&&i.forEach(function(e){var t=h[e];"function"==typeof t?n.push(t):Array.isArray(t)&&(n=n.concat(t))}),n}class VueProxy{constructor(e){this.vueVM=e}getHandle(e){var t=e.type,i=e.target;void 0===i&&(i={});var n=(e.currentTarget||i).dataset;void 0===n&&(n={});var s=n.comkey;void 0===s&&(s="");var r=n.eventid,o=getVM(this.vueVM,s.split(","));if(o){var a=getHandle(o._vnode,r,eventTypeMap[t]||[t]);if(a.length){var u=a[0];if(u.isProxied)return u.proxiedName;try{var h=(""+u).replace("\n","");if(h.match(fnExpRE)){var g=fnExpRE.exec(h);if(g&&g.length>1)return g[1]}}catch(e){}return u.name}}}}class Observer{constructor(e){this.growingio=e,this.weixin=e.weixin,this.currentPage=new Page$1,this.scene=null,this._sessionId=null,this.cs1=null,this.lastPageEvent=void 0,this.lastCloseTime=null,this.lastScene=void 0,this.keepAlive=e.keepAlive,this.isPauseSession=!1,this.CLICK_TYPE={tap:"clck",longpress:"lngprss",longtap:"lngprss"}}get sessionId(){return null===this._sessionId&&(this._sessionId=Utils.guid()),this._sessionId}resetSessionId(){this._sessionId=null}pauseSession(){this.isPauseSession=!0}getVisitorId(){return this.weixin.uid}getUserId(){return this.cs1}setUserId(e){var t=e+"";t&&100>t.length&&(this.cs1=t,this.lastPageEvent&&this._sendEvent(this.lastPageEvent))}clearUserId(){this.cs1=null}appListener(e,t,i){this.isPauseSession||(this.growingio.debug&&console.log("App.",t,Date.now()),"onShow"==t?(this._parseScene(i),!this.lastCloseTime||Date.now()-this.lastCloseTime>this.keepAlive||this.lastScene&&this.scene!==this.lastScene?(this.resetSessionId(),this.sendVisitEvent(i),this.lastPageEvent=void 0):this.useLastPageTime=!0):"onHide"==t?(this.lastScene=this.scene,this.growingio.forceFlush(),this.weixin.syncStorage(),this.isPauseSession||(this.lastCloseTime=Date.now(),this.sendVisitCloseEvent())):"onError"==t&&this.sendErrorEvent(i))}pageListener(e,t,i){if(this.growingio.debug&&console.log("Page.",e.route,"#",t,Date.now()),"onShow"===t)this.isPauseSession?this.isPauseSession=!1:(this.currentPage.touch(e),this.sendPage(e));else if("onLoad"===t){Utils.isEmpty(n=i[0])||this.currentPage.addQuery(e,n)}else if("onShareAppMessage"===t){var n=null,s=null;2>i.length?1===i.length&&(i[0].from?n=i[0]:i[0].title&&(s=i[0])):(n=i[0],s=i[1]),this.pauseSession(),this.sendPageShare(e,n,s)}else if("onTabItemTap"===t){this.sendTabClick(i[0])}}actionListener(e,t){if("handleProxy"===t&&this.growingio.vueRootVMs&&this.growingio.vueRootVMs[this.currentPage.path]){let i=new VueProxy(this.growingio.vueRootVMs[this.currentPage.path]).getHandle(e);i&&(t=i)}this.growingio.debug&&console.log("Click on ",t,Date.now()),"tap"===e.type||"longpress"===e.type?this.sendClick(e,t):-1!==["change","confirm","blur"].indexOf(e.type)?this.sendChange(e,t):"getuserinfo"===e.type?(this.sendClick(e,t),e.detail&&e.detail.userInfo&&this.setVisitor(e.detail.userInfo)):"getphonenumber"===e.type?this.sendClick(e,t):"contact"===e.type&&this.sendClick(e,t)}track(e,t){if(null!==e&&void 0!==e&&0!==e.length){var i={t:"cstm",ptm:this.currentPage.time,p:this.currentPage.path,q:this.currentPage.query,n:e};null!==t&&"object"==typeof t&&(Object.keys(t).forEach((e,i)=>{"string"!=typeof i&&(t[e]=JSON.stringify(t[e]))}),i.var=t),this._sendEvent(i)}}identify(e,t){void 0!==e&&0!==e.length&&(this.growingio.login(e),this._sendEvent({t:"vstr",var:{openid:e,unionid:t}}))}setVisitor(e){this._sendEvent({t:"vstr",var:e})}setUser(e){this._sendEvent({t:"ppl",var:e})}setPage(e){this._sendEvent({t:"pvar",ptm:this.currentPage.time,p:this.currentPage.path,q:this.currentPage.query,var:e})}setEvar(e){this._sendEvent({t:"evar",var:e})}sendVisitEvent(e){var t=this.weixin.systemInfo,i={t:"vst",tm:Date.now(),av:Utils.sdkVer,db:t.brand,dm:t.model.replace(/<.*>/,""),sh:Utils.getScreenHeight(t),sw:Utils.getScreenWidth(t),os:Utils.getOS(t.platform),osv:Utils.getOSV(t.version),l:t.language};if(this.growingio.appVer&&(i.cv=this.growingio.appVer+""),e.length>0){var n=e[0];i.p=n.path,Utils.isEmpty(n.query)||(i.q=this.currentPage._getQuery(n.query)),i.ch=`scn:${this.scene}`,n.referrerInfo&&n.referrerInfo.appId&&(i.rf=n.referrerInfo.appId)}this.weixin.requestLocation().then(()=>{null!=this.weixin.location&&(i.lat=this.weixin.location.latitude,i.lng=this.weixin.location.longitude),this.weixin.getNetworkType().then(e=>{e&&(i.nt=e.networkType),this._sendEvent(i)})})}sendVisitCloseEvent(){this._sendEvent({t:"cls",p:this.currentPage.path,q:this.currentPage.query})}sendErrorEvent(e){if(e&&e.length>0){let t=e[0].split("\n");if(t&&t.length>1){let e=t[1].split(";");if(e&&e.length>1){let i=e[1].match(/at ([^ ]+) page (.*) function/),n={key:t[0],error:e[0]};i&&i.length>2&&(n.page=i[1],n.function=i[2]),this._sendEvent({t:"cstm",ptm:this.currentPage.time,p:this.currentPage.path,q:this.currentPage.query,n:"onError",var:n})}}}}sendPage(e){var t={t:"page",tm:this.currentPage.time,p:this.currentPage.path,q:this.currentPage.query};this.lastPageEvent?(t.rp=this.lastPageEvent.p,this.useLastPageTime&&(t.tm=this.lastPageEvent.tm,this.useLastPageTime=!1)):t.rp=this.scene?`scn:${this.scene}`:null,e.data&&e.data.pvar&&(t.var=e.data.pvar);var i=this.weixin.getPageTitle(e);i&&i.length>0&&(t.tl=i),this._sendEvent(t),this.lastPageEvent=t}sendPageShare(e,t,i){this._sendEvent({t:"cstm",ptm:this.currentPage.time,p:this.currentPage.path,q:this.currentPage.query,n:"onShareAppMessage",var:{from:t?t.from:void 0,target:t&&t.target?t.target.id:void 0,title:i?i.title:void 0,path:i?i.path:void 0}})}sendClick(e,t){var i={t:this.CLICK_TYPE[e.type]||"clck",ptm:this.currentPage.time,p:this.currentPage.path,q:this.currentPage.query},n=e.currentTarget,s={x:`${n.id}#${t}`};n.dataset.title?s.v=n.dataset.title:n.dataset.src&&(s.h=n.dataset.src),void 0!==n.dataset.index&&(s.idx=/^[\d]+$/.test(n.dataset.index)?parseInt(n.dataset.index):-1),i.e=[s],this._sendEvent(i)}sendChange(e,t){var i={t:"chng",ptm:this.currentPage.time,p:this.currentPage.path,q:this.currentPage.query},n=e.currentTarget,s={x:`${n.id}#${t}`};if(-1!==["blur","change","confirm"].indexOf(e.type)&&n.dataset.growingTrack){if(!e.detail.value||0===e.detail.value.length)return;"string"==typeof e.detail.value?s.v=e.detail.value:"[object Array]"===Object.prototype.toString.call(e.detail.value)&&(s.v=e.detail.value.join(","))}"change"===e.type&&e.detail&&e.detail.source&&"autoplay"===e.detail.source||(i.e=[s],this._sendEvent(i))}sendTabClick(e){var t={t:"clck",ptm:this.currentPage.time,p:this.currentPage.path,q:this.currentPage.query,e:[{x:"#onTabItemTap",v:e.text,idx:e.index,h:JSON.stringify(e.pagePath)}]};this._sendEvent(t)}_sendEvent(e){e.u=this.weixin.uid,e.s=this.sessionId,e.tm=e.tm||Date.now(),e.d=this.growingio.appId,e.b="MinP",null!==this.cs1&&(e.cs1=this.cs1),this.growingio.upload(e)}_parseScene(e){if(e.length>0){var t=e[0];t.scene&&(this.scene=t.scene)}}}class Weixin{constructor(e){this._location=null,this._systemInfo=null,this._uid=wx.getStorageSync("_growing_uid_"),this._uid&&36!==this._uid.length&&(e.forceLogin=!1),this._esid=wx.getStorageSync("_growing_esid_")}get location(){return this._location}get systemInfo(){return null==this._systemInfo&&(this._systemInfo=wx.getSystemInfoSync()),this._systemInfo}set esid(e){this._esid=e,wx.setStorageSync("_growing_esid_",this._esid)}get esid(){return this._esid||(this._esid=1),this._esid}set uid(e){this._uid=e,wx.setStorageSync("_growing_uid_",this._uid)}get uid(){return this._uid||(this.uid=Utils.guid()),this._uid}syncStorage(){wx.getStorageSync("_growing_uid_")||wx.setStorageSync("_growing_uid_",this._uid)}requestLocation(){return new Promise(e=>{this._getSetting().then(t=>{if(!(t&&t.authSetting&&t.authSetting["scope.userLocation"]))return e(null);this._getLocation().then(t=>(this._location=t,e(t)))})})}getNetworkType(){return new Promise(e=>{wx.getNetworkType({success:t=>e(t),fail:()=>e(null)})})}getPageTitle(e){var t="";try{if(e.data.title&&e.data.title.length>0&&(t=Array.isArray(e.data.title)?e.data.title.join(" "):e.data.title),0===t.length&&__wxConfig){if(__wxConfig.tabBar){var i=__wxConfig.tabBar.list.find(t=>t.pathPath==e.route||t.pagePath==`${e.route}.html`);i&&i.text&&(t=i.text)}if(0==t.length){var n=__wxConfig.page[e.route]||__wxConfig.page[`${e.route}.html`];t=n?n.window.navigationBarTitleText:__wxConfig.global.window.navigationBarTitleText}}}catch(e){}return t}_getSetting(){return new Promise(e=>{wx.getSetting({success:e,fail:e})})}_getLocation(){return new Promise(e=>{wx.getLocation({success:e,fail:function(){return e(null)}})})}}var VdsInstrumentAgent={defaultPageCallbacks:{},defaultAppCallbacks:{},appHandlers:["onShow","onHide","onError"],pageHandlers:["onLoad","onShow","onShareAppMessage","onTabItemTap"],actionEventTypes:["tap","longpress","blur","change","confirm","getuserinfo","getphonenumber","contact"],originalPage:Page,originalApp:App,originalComponent:Component,originalBehavior:Behavior,hook:function(e,t){return function(){var i,n=arguments?arguments[0]:void 0;if(n&&n.currentTarget&&-1!=VdsInstrumentAgent.actionEventTypes.indexOf(n.type))try{VdsInstrumentAgent.observer.actionListener(n,e)}catch(e){console.error(e)}if(this._growing_app_&&"onShow"!==e?i=t.apply(this,arguments):this._growing_page_&&-1===["onShow","onLoad","onTabItemTap"].indexOf(e)&&(i=t.apply(this,arguments)),this._growing_app_&&-1!==VdsInstrumentAgent.appHandlers.indexOf(e)){try{VdsInstrumentAgent.defaultAppCallbacks[e].apply(this,arguments)}catch(e){console.error(e)}"onShow"===e&&(i=t.apply(this,arguments))}if(this._growing_page_&&-1!==VdsInstrumentAgent.pageHandlers.indexOf(e)){var s=Array.prototype.slice.call(arguments);i&&s.push(i);try{VdsInstrumentAgent.defaultPageCallbacks[e].apply(this,s)}catch(e){console.error(e)}if(-1!==["onShow","onLoad","onTabItemTap"].indexOf(e))i=t.apply(this,arguments);else{var r=VdsInstrumentAgent.observer.growingio;r&&r.followShare&&i.path&&(i.path=-1===i.path.indexOf("?")?i.path+"?suid="+r.weixin.uid:i.path+"&suid="+r.weixin.uid)}}return i}},hookComponent:function(e,t){return function(){var i=arguments?arguments[0]:void 0;if(i&&i.currentTarget&&-1!=VdsInstrumentAgent.actionEventTypes.indexOf(i.type))try{VdsInstrumentAgent.observer.actionListener(i,e)}catch(e){console.error(e)}return t.apply(this,arguments)}},instrument:function(e){for(var t in e)"function"==typeof e[t]&&(e[t]=this.hook(t,e[t]));return e._growing_app_&&VdsInstrumentAgent.appHandlers.map(function(t){e[t]||(e[t]=VdsInstrumentAgent.defaultAppCallbacks[t])}),e._growing_page_&&VdsInstrumentAgent.pageHandlers.map(function(t){e[t]||"onShareAppMessage"===t||(e[t]=VdsInstrumentAgent.defaultPageCallbacks[t])}),e},instrumentComponent:function(e){if(e.methods){let t=e.methods;for(let i in t)"function"==typeof t[i]&&(e.methods[i]=this.hookComponent(i,t[i]))}return e},GrowingPage:function(e){return e._growing_page_=!0,VdsInstrumentAgent.originalPage(VdsInstrumentAgent.instrument(e))},GrowingComponent:function(e){return VdsInstrumentAgent.originalComponent(VdsInstrumentAgent.instrumentComponent(e))},GrowingBehavior:function(e){return VdsInstrumentAgent.originalBehavior(VdsInstrumentAgent.instrumentComponent(e))},GrowingApp:function(e){return e._growing_app_=!0,VdsInstrumentAgent.originalApp(VdsInstrumentAgent.instrument(e))},initInstrument:function(e,t){VdsInstrumentAgent.observer=e,VdsInstrumentAgent.pageHandlers.forEach(function(e){VdsInstrumentAgent.defaultPageCallbacks[e]=function(){this.__route__&&VdsInstrumentAgent.observer.pageListener(this,e,arguments)}}),VdsInstrumentAgent.appHandlers.forEach(function(e){VdsInstrumentAgent.defaultAppCallbacks[e]=function(){VdsInstrumentAgent.observer.appListener(this,e,arguments)}}),t?(global.GioPage=VdsInstrumentAgent.GrowingPage,global.GioApp=VdsInstrumentAgent.GrowingApp,global.GioComponent=VdsInstrumentAgent.GrowingBehavior,global.GioBehavior=VdsInstrumentAgent.GrowingBehavior):(Page=function(){return VdsInstrumentAgent.GrowingPage(arguments[0])},App=function(){return VdsInstrumentAgent.GrowingApp(arguments[0])},Component=function(){return VdsInstrumentAgent.GrowingComponent(arguments[0])},Behavior=function(){return VdsInstrumentAgent.GrowingBehavior(arguments[0])})}};class GrowingIO{constructor(){this.uploadingMessages=[]}init(e,t,i={}){this.projectId=e,this.appId=t,this.appVer=i.version,this.debug=i.debug||!1,this.forceLogin=i.forceLogin||!1,this.followShare=i.followShare||!1,this.usePlugin=i.usePlugin||!1,this.keepAlive=+i.keepAlive||3e4,this.weixin=new Weixin(this),this.esid=this.weixin.esid,this.uploader=new Uploader(this.projectId,this.appId),this.observer=new Observer(this),i.vue&&(this.vueRootVMs={},this._proxyVue(i.vue)),this._start()}setHost(e){this.uploader.setHost(e)}setVue(e){this.vueRootVMs||(this.vueRootVMs={}),this._proxyVue(e)}login(e){if(this.forceLogin)for(var t of(this.weixin.uid=e,this.forceLogin=!1,this.uploadingMessages))t.u=e,this._upload(t)}upload(e){this.forceLogin?this.uploadingMessages.push(e):this._upload(e)}forceFlush(){this.weixin.esid=this.esid,this.uploader.forceFlush()}proxy(e,t){try{if("setVue"===e)this.setVue(t[0]);else if(this.observer&&this.observer[e])return this.observer[e].apply(this.observer,t)}catch(e){console.error(e)}}_start(){VdsInstrumentAgent.initInstrument(this.observer,this.usePlugin);try{global&&global["__core-js_shared__"]&&(global.App=App,global.Page=Page,global.Component=Component)}catch(e){console.error(e)}}_upload(e){e.esid=this.esid++,this.debug&&console.info("generate new event",JSON.stringify(e,0,2)),this.uploader.upload(e)}_proxyVue(e){if(void 0!==e.mixin){let t=this;e.mixin({created:function(){if(!this.$options.methods)return;const e=Object.keys(this.$options.methods);for(let t of Object.keys(this))0>e.indexOf(t)||(Object.defineProperty(this[t],"proxiedName",{value:t}),Object.defineProperty(this[t],"isProxied",{value:!0}))},beforeMount:function(){let e=this.$root;e.$mp&&"page"===e.$mp.mpType&&e.$mp.page&&(t.vueRootVMs[e.$mp.page.route]=e)}})}}}var growingio=new GrowingIO,gio=function(){var e=arguments[0];if(e){var t=2>arguments.length?[]:[].slice.call(arguments,1);if("init"!==e)return growingio.proxy(e,t);if(t.length<2)console.log("初始化 GrowingIO SDK 失败。请使用 gio('init', '你的GrowingIO项目ID', '你的微信APP_ID', options);");else growingio.init(t[0],t[1],t[2])}};console.log("init growingio...");const GioPage=VdsInstrumentAgent.GrowingPage,GioApp=VdsInstrumentAgent.GrowingApp,GioComponent=VdsInstrumentAgent.GrowingComponent,GioBehavior=VdsInstrumentAgent.GioBehavior;exports.GioPage=GioPage,exports.GioApp=GioApp,exports.GioComponent=GioComponent,exports.GioBehavior=GioBehavior,exports.default=gio;
